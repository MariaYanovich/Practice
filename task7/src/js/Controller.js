let posts2 =[{
    id: '1',
    description: 'Something',
    createdAt: new Date('2018-02-23T13:50:00'),
    author: 'masha',
    photoLink: 'image-1.jpg',
    likes: ['masha','lia', 'katya', 'vera'],
    hashTags: ['#sport', '#enjoy','#like', '#winners'],
    isDeleted: false,
},
    {
        id: '2',
        description: 'Something',
        createdAt: new Date('2016-03-08T11:00:00'),
        author: 'masha',
        photoLink: 'image-2.jpg',
        likes: [],
        hashTags: ['#sport', '#enjoysport', '#winners'],
        isDeleted: false,

    },
    {
        id: '3',
        description: 'Something',
        createdAt: new Date('2018-03-08T11:00:00'),
        author: 'katya',
        photoLink: 'image-3.jpg',
        likes: ['masha','lia', 'vera'],
        hashTags: ['#sport', '#enjoysport', '#winners'],
        isDeleted: false,

    },
    {
        id: '4',
        description: 'Something',
        createdAt: new Date('2018-02-09T11:00:00'),
        author: 'den',
        photoLink: 'image-4.jpg',
        likes: ['masha','lia', 'katya', 'vera'],
        hashTags: ['#competitions', '#enjoysport', '#winners'],
        isDeleted: false,

    },
    {
        id: '5',
        description: 'Something',
        createdAt: new Date('2018-03-08T11:00:00'),
        author: 'den',
        photoLink: 'image-5.jpg',
        likes: ['lia', 'katya', 'vera'],
        hashTags: ['#sport', '#enjoysport', '#winners'],
        isDeleted: false,

    },
    {
        id: '6',
        description: 'Something',
        createdAt: new Date('2018-04-17T13:05:00'),
        author: 'katya',
        photoLink: 'image-6.jpeg',
        likes: ['masha','lia', 'katya', 'vera'],
        hashTags: ['#sport', '#enjoysport'],
        isDeleted: false,

    },
    {
        id: '7',
        description: 'Something',
        createdAt: new Date('2018-03-08T12:00:00'),
        author: 'masha',
        photoLink: 'image-7.jpg',
        likes: ['masha','lia', 'katya', 'vera'],
        hashTags: ['#enjoysport', '#winners'],
        isDeleted: false,

    },
    {
        id: '8',
        description: 'Something',
        createdAt: new Date('20006-11-08T11:00:00'),
        author: 'katya',
        photoLink: 'image-8.jpg',
        likes: ['masha', 'katya', 'vera'],
        hashTags: ['#sport', '#enjoysport', '#winners'],
        isDeleted: false,

    },
    {
        id: '9',
        description: 'Something',
        createdAt: new Date('2018-09-01T17:00:00'),
        author: 'masha',
        photoLink: 'image-9.jpg',
        likes: ['masha','lia', 'katya', 'vera'],
        hashTags: ['#fun', '#enjoysport', '#winners'],
        isDeleted: false,

    },
    {
        id: '10',
        description: 'Something',
        createdAt: new Date('2019-01-09T11:00:00'),
        author: 'den',
        photoLink: 'image-10.jpg',
        likes: ['masha','lia', 'katya', 'vera'],
        hashTags: ['#sport', '#like', '#winners'],
        isDeleted: false,

    },
    {
        id: '11',
        description: 'Something',
        createdAt: new Date('2018-03-13T21:00:00'),
        author: 'masha',
        photoLink: 'image11.jpg',
        likes: ['masha','lia', 'katya', 'vera'],
        hashTags: ['#sport', '#enjoysport', '#justsport'],
        isDeleted: false,

    },
    {
        id: '12',
        description: 'Something',
        createdAt: new Date('2018-10-07T11:05:00'),
        author: 'katya',
        photoLink: 'image13.jpg',
        likes: ['masha','lia', 'katya', 'vera'],
        hashTags: ['#sport', '#enjoysport', '#winners'],
        isDeleted: false,

    },
    {
        id: '13',
        description: 'Something',
        createdAt: new Date('2018-12-03T22:00:00'),
        author: 'lena',
        photoLink: 'image16.jpg',
        likes: ['masha','lia', 'vera'],
        hashTags: ['#sport', '#enjoysport', '#winners'],
        isDeleted: false,

    },
    {
        id: '14',
        description: 'Something',
        createdAt: new Date('2010-07-15T16:00:00'),
        author: 'sandro',
        photoLink: 'image15.jpg',
        likes: ['lia', 'katya', 'vera'],
        hashTags: ['#sport', '#enjoysport', '#winners'],
        isDeleted: false,

    },
    {
        id: '15',
        description: 'Something',
        createdAt: new Date('2017-07-08T11:00:00'),
        author: 'vera',
        photoLink: 'image-10.jpg',
        likes: ['masha','lia', 'katya', 'vera'],
        hashTags: ['#sport', '#enjoysport', '#winners'],
        isDeleted: false,

    },
    {
        id: '16',
        description: 'Something',
        createdAt: new Date('2018-03-08T11:00:00'),
        author: 'mur',
        photoLink: 'image18.png',
        likes: [],
        hashTags: ['#sport', '#enjoysport', '#winners'],
        isDeleted: false,

    },
    {
        id: '17',
        description: 'Something',
        createdAt: new Date('2001-05-18T18:00:00'),
        author: 'lia',
        photoLink: 'image-8.jpg',
        likes: ['masha','lia'],
        hashTags: ['#sport', '#enjoysport', '#winners'],
        isDeleted: false,

    },
    {
        id: '18',
        description: 'Something',
        createdAt: new Date('2018-08-14T16:30:00'),
        author: 'masha',
        photoLink: 'image20.jpg',
        likes: ['masha','lia', 'katya', 'vera'],
        hashTags: ['#sport', '#enjoysport', '#winners'],
        isDeleted: false,

    },
    {
        id: '19',
        description: 'Something',
        createdAt: new Date('2018-06-08T14:00:00'),
        author: 'vera',
        photoLink: 'image19.jpg',
        likes: ['masha','katya', 'vera'],
        hashTags: ['#sport', '#winners'],
        isDeleted: false,

    },
    {
        id: '20',
        description: 'Something',
        createdAt: new Date('2018-09-14T18:00:00'),
        author: 'den',
        photoLink: 'image-1.jpg',
        likes: ['masha','lia', 'katya', 'vera'],
        hashTags: ['#sport', '#enjoysport', '#winners'],
        isDeleted: false,

    }
];

class Controller {
    constructor() {
        this.countOfPosts = 0;
        this.posts2 = JSON.parse(localStorage.getItem("posts"));
        this.posts2 = PostCollection._sortAllPostsByDate(this.posts2);
        var user = localStorage.getItem("user");
        this.collection = new PostCollection(this.posts2);
        this.filterConfig = {};
        this.h = new View();
        this.editPhotoPath = false;
        this.EditPostId = false;
        if(user) {
            this.currentUser = user;
            this.h.setUser(this.currentUser);
        }
        this.reloadPage();
    }

    enter(name) {
        this.currentUser = name;
        this.h.setUser(name);
        let posts = this.collection.getPage(this.filterConfig, 10, 0);
        this.h.reloadPage(posts);
        localStorage.setItem("user",this.currentUser);
        events.delAndEditBtnsActivate();
    }

    addPosts() {
        let posts = this.collection.getPage(this.filterConfig, 10, this.countOfPosts);
        if (posts.length !=0) {
            this.h.addPosts(posts);
            this.countOfPosts += 10;
            events.delAndEditBtnsActivate();

        }
    }
    exit(){
        this.countOfPosts = 0;
        this.currentUser = false;
        this.h.exit();
    }
    addNewPost(post){
        post.author = this.currentUser;
        if (this.collection.add(post)) {
            this.h.addPost(post);
            this.save();
        }
        document.querySelector(".content").style.display = "flex";
        events.delAndEditBtnsActivate();


    }
    deletePost(id) {
        if (this.collection.remove(id)) {
            this.h.deletePost(id);
            this.save();
        }
    }
    save(){
        localStorage.setItem("posts", JSON.stringify(this.collection._photoPosts));
    }
    filterPosts(filterConfig){
        this.collection = new PostCollection(this.collection.getPage(filterConfig));
        this.h.reloadPage(this.collection);
    }
    reloadPage(){
        this.countOfPosts = 0;
        let reloadPhotos = this.collection.getPage(this.filterConfig, 10, this.countOfPosts);
        this.h.reloadPage(reloadPhotos);
        this.countOfPosts+=10;

    }
    removeLike(likeId){
        this.collection.removeLike(likeId,this.currentUser);

    }

}
class Events{
    constructor() {
        let logIn = document.getElementById('log_in');
        logIn.addEventListener("click", this.authorizationFormActivate);
        let exitBtn = document.getElementById('exit_button');
        exitBtn.addEventListener("click", this.exit);
        let morePosts = document.querySelector('.More_posts button');
        morePosts.addEventListener("click", this.addPosts);
        let newPost = document.querySelector('.new_Post button');
        newPost.addEventListener("click", this.createNewPostFormActivate);
        let login = document.getElementsByName("authorization")[0];
        login.addEventListener("submit", this.authorization);
        let createNewPost = document.getElementsByName("createPost")[0];
        createNewPost.addEventListener("submit", this.createPost);
        let filter = document.querySelector(".filter");
        filter.addEventListener("submit", this.getFilterConfig);
        let edit = document.getElementsByName("editPost")[0];
        edit.addEventListener("submit", this.edit);
        this.delAndEditBtnsActivate();
    }
    delAndEditBtnsActivate(){
        let delBtn = document.getElementsByClassName("deletePostButton");
        Array.prototype.forEach.call(delBtn, (btn)=>{
            btn.addEventListener("click",this.deletePost)
        });
        let editBtn = document.getElementsByClassName("settings");
        Array.prototype.forEach.call(editBtn, (btn)=>{
            btn.addEventListener("click",this.editPostFormActivate)
        });
        let likeBtn = document.getElementsByClassName("like_button");
        Array.prototype.forEach.call(likeBtn, (btn)=>{
            btn.addEventListener("click",this.likePost)
        });
    }

    getFilterConfig(e){
        e.preventDefault();
        let filterConfig ={};
        let filterForm = document.querySelector(".filter");
        let author = filterForm.elements[0].value;
        if(author !== ""){
            filterConfig.author = author;
        }

        let hashTags = filterForm.elements[1].value;
        if(hashTags !== ""){
            filterConfig.hashTags = hashTags.split(' ');
        }
        controller.filterConfig = filterConfig;
        controller.reloadPage();
    }
    authorizationFormActivate(){

        document.querySelector(".content").style.display = "none";
        document.querySelector(".authorizationForm").style.display = "flex";
        document.querySelector(".More_posts").style.display = "none";
        document.querySelector(".filter").style.display = "none";

    }
    authorization (e) {
        e.preventDefault();
        let name = document.getElementsByName("login")[0].value;
        let password = document.getElementsByName("password")[0].value;
        let passwordStorage = localStorage.getItem(name);
        if (passwordStorage === password){
            document.querySelector(".authorizationForm").style.display = "none";
            document.querySelector(".filter").style.display = "flex";

            controller.enter(name);
        }
        document.authorization.reset();

    }

    exit(){
        controller.exit();
    }
    createNewPostFormActivate(){
        document.querySelector(".content").style.display = "none";
        document.querySelector(".createNewPostForm").style.display = "flex";
        document.querySelector(".More_posts").style.display = "none";
    }
    deletePost(event){
        controller.deletePost(event.path[3].id);
    }
    editPostFormActivate(event){
        let post= event.path[3];
        controller.editPhotoPath = post.querySelector("img").src;
        controller.EditPostId = post.id;
        let description = post.querySelector(".description").innerHTML;
        let hashTags = post.querySelector(".hashTag").innerHTML;
        document.querySelector(".content").style.display = "none";
        document.querySelector(".More_posts").style.display = "none";
        document.querySelector(".filter").style.display = "none";
        let editPost = document.querySelector(".editPostForm");
        editPost.style.display = "flex";
        editPost.querySelector("img").src = controller.editPhotoPath;
        editPost.querySelector(".descriptionInput").value = description;
        editPost.querySelector(".hashTagsInput").value = hashTags;
    }
    likePost(event){
        if(controller.currentUser){
            let likeId = event.path[3].id;
            let color = event.path[0].style.color;
            if(color === "red"){
                controller.removeLike(likeId);
                event.path[0].style = "#9E9C9C;";
            }
            else{
                controller.collection.addLike(likeId,controller.currentUser);
                event.path[0].style="color:red";

            }
            controller.save();

        }
    }
    createPost(e){
        e.preventDefault();
        let post = {};
        post.photoLink = document.getElementsByName("photoLink")[0].value.substr(12);
        post.description = document.getElementsByName("description")[0].value;
        post.hashTags = document.getElementsByName("hashTags")[0].value.split(' ');
        document.createPost.reset();
        document.querySelector(".createNewPostForm").style.display = "none";
        controller.addNewPost(post);

    }
    edit(e){
        e.preventDefault();
        let post ={};
        post.photoLink = document.querySelector(".photoLinkBtn").value.substr(12)|| controller.editPhotoPath;
        post.description = document.querySelector(".descriptionInput").value;
        post.hashTags = document.querySelector(".hashTagsInput").value.split(' ');
        document.editPost.reset();
        if(controller.collection.edit(controller.EditPostId,post)){
            document.querySelector(".editPostForm").style.display = "none";
            document.querySelector(".More_posts").style.display = "block";
            document.querySelector(".filter").style.display = "flex";
            controller.save();
            controller.reloadPage();
            events.delAndEditBtnsActivate();

        }
    }
    addPosts(){
        controller.addPosts();
    }
}

class LocalStorageInitialization{
    constructor (posts){
        if(!localStorage.length){
            localStorage.setItem("posts", JSON.stringify(posts));
            localStorage.setItem("masha", "masha");
            localStorage.setItem("lia", "lia");
            localStorage.setItem("lena", "lena");
            localStorage.setItem("katya", "katya");
        }

    }
}
let init = new LocalStorageInitialization(posts2);
let controller = new Controller();
let events = new Events();
